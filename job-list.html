<!DOCTYPE HTML>
<html>

<head>

    <title>파엠 if 데이터베이스</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <meta name="description" content="파엠 if 데이터베이스">
    <!-- <meta property="og:url" content="http://feh.wiki/thracia/index.php?title=오프닝"> -->
    <meta property="og:title" content="파엠 if 데이터베이스">
    <meta property="og:type" content="website">
    <!-- <meta property="og:image" content="../images/metaimg.png"> -->
    <meta property="og:description" content="파엠 if 데이터베이스">
    <meta property="og:site_name" content="파엠 if 데이터베이스">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="shortcut icon" href="images/thra/lightbrand_57.png" type="image/x-icon"/>
    <link rel="icon" href="images/thra/lightbrand_57.png" type="image/x-icon"/>
    <link rel="apple-touch-icon" sizes="57x57" href="images/thra/lightbrand_57.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="images/thra/lightbrand_114.png"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css">
    <link rel="stylesheet" href="assets/css/select2.min.css"/>
    <link rel="stylesheet" href="assets/css/main.css"/>

</head>
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
        integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>

<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light" id="navBar">
    <div class="container-fluid" style="margin : 0 10px">
        <a class="navbar-brand" href="#">파엠 if 데이터베이스</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="index.html">스킬 리스트</a></li>
                <li class="nav-item"><a class="nav-link active" href="job-list.html">클래스 리스트</a></li>
                <li class="nav-item"><a class="nav-link" href="unit-list.html">유닛 리스트</a></li>
            </ul>
        </div>
    </div>
</nav>
<a style="position : fixed; bottom : 20px; right : 20px; width : 50px; height : 50px; border-radius: 100px; z-index: 9999;" href="#"
   onclick="scrollTop_func();return false;">
    <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="#3ba056" class="bi bi-arrow-up-circle-fill"
         viewBox="0 0 16 16">
        <path d="M16 8A8 8 0 1 0 0 8a8 8 0 0 0 16 0zm-7.5 3.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z"></path>
    </svg>
</a>
<div class="container">
    <br>
    <div class="row">
        <div class="col">
            <table id="table"
                   data-show-fullscreen="true"
                   data-detail-view="true"
                   data-detail-view-icon="false"
                   data-detail-view-by-click="true"
                   data-detail-formatter="skill_detail_formatter"
                   data-search="true"
                   data-show-columns="true">
                <thead>
                <tr>
                    <th data-field="ID" data-sortable="true" data-visible="false">내부 순서</th>
                    <th data-field="name" data-sortable="true">클래스명</th>
                    <th data-field="description">설명</th>
                    <th data-field="getSkillIcon">습득 스킬</th>
                    <th data-field="class_rank_text" data-visible="false" data-sortable="true">종류</th>
                    <th data-field="upper_class" data-visible="false">상위 클래스</th>
                    <th data-field="firstclass_unit" data-visible="false">주직업 유닛</th>
                    <th data-field="secondclass_unit" data-visible="false">부직업 유닛</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
    <div style="height : 50px"></div>
</div>

</body>
</html>
<script>

    let skillTableData;
    let jobDictionary;

    $(document).ready(function () {
        let prefix = "";
        if (window.location.href.includes("cass07")) {
            prefix = "";
        } else {
            prefix = "http://localhost:63343/fe14-db/"
        }

        let jobData = [];
        jobDictionary = [];
        let skillData = [];
        let jobChangeData = [];
        let unitData = [];
        $.getJSON("data/fe14-job.json", jsonDataTable => {
            jsonDataTable.forEach(item => {
                jobData.push(item);
                jobDictionary[item.JID] = item;
            })
        }).then($.getJSON("data/fe14-skill.json", jsonDataTable => {
            jsonDataTable.forEach(item => {
                skillData[item.SEID] = item;
            })
        })).then($.getJSON("data/class_change.json", jsonDataTable => {
            jsonDataTable.forEach(item => {
                jobChangeData.push(item);
            })
        })).then(function () {
            skillTableData = makeSkillResultTable(jobData);
            $("#table").bootstrapTable({data: skillTableData});
        });


    });

    function makeSkillResultTable(jobJson) {
        jobJson.forEach((singleJob, index, array) => {
            let getSkillHtml = "";
            singleJob.skill_array.forEach(singleSkill => {
                getSkillHtml += `${singleSkill.icon} ${singleSkill.skill_name}<br>`;
            })
            array[index].getSkillIcon = getSkillHtml.slice(0,-4);

            //클래스 상하위 텍스트
            if(singleJob.class_rank === 2) {
                array[index].class_rank_text = "상위직";
            }else if(singleJob.class_rank === 1) {
                array[index].class_rank_text = "하위직";
            }else {
                array[index].class_rank_text = "특수직";
            }

            //클래스체인지 텍스트
            let upperClassText = "-";
            if(singleJob.class_rank === 1) {
                upperClassText = "";
                singleJob.change_array.forEach(singleClassChange => {
                    upperClassText += `${jobDictionary[singleClassChange.JID].name}<br>`;
                })
                upperClassText = upperClassText.slice(0,-4);
            }
            array[index].upper_class = upperClassText;

            //소지 유닛 텍스트
            let firstUnitText = "-";
            if(singleJob.firstjob_array !== undefined) {
                firstUnitText = "";
                singleJob.firstjob_array.forEach(singleJobUnit => {
                    firstUnitText += `${singleJobUnit.name}<br>`;
                });
                firstUnitText = firstUnitText.slice(0,-2);
            }
            array[index].firstclass_unit = firstUnitText;

            let secondUnitText = "";
            if(singleJob.secondjob_array !== undefined) {
                singleJob.secondjob_array.forEach(singleJobUnit => {
                    secondUnitText += `${singleJobUnit.name}<br>`;
                });
                secondUnitText = secondUnitText.slice(0,-2);
            }
            if(singleJob.thirdjob_array !== undefined) {
                singleJob.thirdjob_array.forEach(singleJobUnit => {
                    secondUnitText += `${singleJobUnit.name}<br>`;
                });
                secondUnitText = secondUnitText.slice(0,-2);
            }
            if (secondUnitText === "") {
                secondUnitText = "-";
            }

            array[index].secondclass_unit = secondUnitText;


        })
        return jobJson;
    }
    function insertSkillDatatoJobData(jobData, skillData) {
        jobData.forEach((singleJob, index, array) =>{
            let jobSkillArray = [];
            for (let i = 1; i <= 4; i++){
                let sid = singleJob['skill' + i];
                if(skillData[sid] !== undefined) {
                    //스킬 존재함
                    let skillDataObject = {};
                    skillDataObject.icon = skillData[sid].icon;
                    skillDataObject.SEID = skillData[sid].SEID;
                    skillDataObject.skill_name = skillData[sid].name;
                    skillDataObject.description = skillData[sid].description;

                    //스킬 습득 레벨
                    if(i === 1) {
                        if(singleJob.class_rank === 1 || singleJob.class_rank === 0) {
                            skillDataObject.get_level = 1;
                        } else if (singleJob.class_rank === 2) {
                            skillDataObject.get_level = 5;
                        }
                    } else if (i === 2) {
                        if(singleJob.class_rank === 1 || singleJob.class_rank === 0) {
                            skillDataObject.get_level = 10;
                        } else if (singleJob.class_rank === 2) {
                            skillDataObject.get_level = 15;
                        }
                    } else if (i === 3) {
                        skillDataObject.get_level = 25;
                    } else if (i === 4) {
                        skillDataObject.get_level = 35;
                    }

                    jobSkillArray.push(skillDataObject);
                }
            }
            array[index].skill_array = jobSkillArray;
        });

        return jobData;
    }

    function insertChangeDatatoJobData(jobData, changeData) {
        let changeKeyArray = [];
        changeData.forEach(singleChange => {
            changeKeyArray[singleChange.base_JID] = singleChange;
            console.log(singleChange.base_JID);


            /*
            singleChange.change_JID_array.forEach(singleHighclassData => {
                if(changeKeyArray[singleHighclassData.JID] === undefined) {
                    changeKeyArray[singleHighclassData.JID] = {};
                    changeKeyArray[singleHighclassData.JID].result_JID = singleHighclassData.JID;
                    changeKeyArray[singleHighclassData.JID].change_JID_array = [];
                }
                let lowJIDObject = {};
                lowJIDObject.condition = 0;
                lowJIDObject.JID = singleChange.base_JID;
                changeKeyArray[singleHighclassData.JID].change_JID_array.push(lowJIDObject)
            })
             */

        })
        console.log(changeKeyArray);

        jobData.forEach((singleJob, index, array) =>{
            let jobChangeArray = [];
            if(changeKeyArray[singleJob.JID] !== undefined) {
                array[index].change_array = changeKeyArray[singleJob.JID].change_JID_array;
            }
        });

        console.log(JSON.stringify(jobData));

        return jobData;
    }

    function skill_detail_formatter(index, row) {
        //let html = []

        let detailText = `${row.name}<br>${row.description}<br>`;
        if(row.class_rank === 2) {
            detailText += "<br>상위직";
        }else if (row.class_rank === 1) {
            detailText += "<br>하위직";
            //가능한 상위직 추가
        }else if (row.class_rank === 0) {
            detailText += "<br>특수직 (최대 레벨 40)";
        }

        if(row.class_rank === 2 || row.class_rank === 1) {
            //가능한 하위/상위직 추가
            detailText += "<br>";
            row.change_array.forEach(singleClassChange => {
                detailText += `【${jobDictionary[singleClassChange.JID].name}】, `;
            })
            detailText = detailText.slice(0,-2);
            detailText += (row.class_rank === 2? "에서 클래스 체인지 가능": (isBatchim(detailText.slice(detailText.length-2,detailText.length-1))?"":"으")+ "로 클래스 체인지 가능");
        }

        if(row.inheritable === 1) {
            detailText += "<br>버디/매리지 프루프로 전달 불가, 자식에게 계승만 가능";
        }else if(row.inheritable === 2) {
            detailText += "<br>버디/매리지 프루프로 전달 불가, 자식에게 계승 불가";
        }

        if(row.gender === 1) {
            detailText += "<br>남성 전용";
        }else if(row.gender === 2) {
            detailText += "<br>여성 전용";
        }

        detailText += "<br><br>";
        //계승 스킬 출력
        row.skill_array.forEach(singleSkill => {
            detailText += `${singleSkill.get_level}레벨 - ${singleSkill.icon} ${singleSkill.skill_name}<br>${singleSkill.description}<br>`;
        });

        if (row.skillPersonalUnitArray !== undefined) {
            //개인 스킬
            console.log(row.skillPersonalUnitArray);
            detailText += "<br><br>개인 스킬 : ";
            row.skillPersonalUnitArray.forEach(singleUnit => {
                detailText += `${singleUnit.unit_name}, `;
            })
            detailText = detailText;
        }


        //클래스체인지 병과와 스킬 출력
        if (row.class_rank === 1) {
            detailText += "<br><br>";
            row.change_array.forEach(singleClassChange => {
                detailText += `【${jobDictionary[singleClassChange.JID].name}】${(isBatchim(jobDictionary[singleClassChange.JID].name)?"":"으")}로 클래스체인지 했을 때 얻을 수 있는 스킬<br>`;
                jobDictionary[singleClassChange.JID].skill_array.forEach(singleSkill => {
                    detailText += `${singleSkill.get_level}레벨 - ${singleSkill.icon} ${singleSkill.skill_name}<br>${singleSkill.description}<br>`;
                });
                detailText += "<br>";
            })
            detailText = detailText.slice(0,-4);
        }

        //소지 캐릭터 출력
        if(row.firstjob_array !== undefined) {
            detailText += "<br><br>위 클래스를 주직업으로 가진 유닛 : ";
            row.firstjob_array.forEach(singleJobUnit => {
                detailText += `【${singleJobUnit.name}】, `;
            });
            detailText = detailText.slice(0,-2);
        }
        if(row.secondjob_array !== undefined) {
            detailText += "<br>위 클래스를 부직업으로 가진 유닛 : ";
            row.secondjob_array.forEach(singleJobUnit => {
                detailText += `【${singleJobUnit.name}】, `;
            });
            detailText = detailText.slice(0,-2);
        }
        if(row.thirdjob_array !== undefined) {
            detailText += "<br>위 클래스를 2번째 부직업으로 가진 유닛 (계승, 전달 불가) : ";
            row.thirdjob_array.forEach(singleJobUnit => {
                detailText += `【${singleJobUnit.name}】, `;
            });
            detailText = detailText.slice(0,-2);
        }



        return detailText;
    }

    //받침이 없거나 ㄹ(8)이라면 로, 아니라면 으로
    function isBatchim(word) {
        let lastStrCode = word.charCodeAt(word.length-1);
        if (lastStrCode < 44032 || lastStrCode > 55203) return 0;
        return (lastStrCode - 44032) % 28 === 0 || (lastStrCode - 44032) % 28 === 8 ;
    }

    function scrollTop_func() {
        $('html, body').animate({
            scrollTop: $("#navBar").offset().top
        }, 100, 'linear');
    }

</script>
